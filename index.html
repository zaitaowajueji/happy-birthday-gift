<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Gift For You</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        #canvas-container { width: 100vw; height: 100vh; }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #d4af37; font-family: 'Times New Roman', serif; letter-spacing: 5px;
            font-size: 14px; opacity: 0.8; transition: opacity 1s; pointer-events: none;
        }
        .instruction {
            position: absolute; bottom: 10%; width: 100%; text-align: center;
            color: #fff; font-family: sans-serif; font-weight: 100; opacity: 0;
            transition: opacity 2s; letter-spacing: 2px; font-size: 12px; pointer-events: none;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="loading">LOADING MAGIC...</div>
    <div id="instruction" class="instruction">CLICK THE CUBE</div>
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';

        // --- 场景初始化 ---
        const scene = new THREE.Scene();
        // 增加一点点环境雾气，增加深邃感
        scene.fog = new THREE.FogExp2(0x000000, 0.02);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 30); // 初始远距离

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ReinhardToneMapping; // 电影感色调映射
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enableZoom = false; // 暂时锁定缩放，保持电影构图

        // --- 材质定义 (奢华金) ---
        const goldMaterial = new THREE.MeshStandardMaterial({
            color: 0xffd700,      // 纯金
            metalness: 1.0,       // 全金属
            roughness: 0.15,      // 非常光滑
            emissive: 0x221100,   // 微微自发光
        });

        const particleMaterial = new THREE.PointsMaterial({
            color: 0xffeb3b,
            size: 0.1,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending
        });

        // --- 灯光系统 (舞台感) ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.1); // 微弱环境光
        scene.add(ambientLight);

        const pointLight = new THREE.PointLight(0xffaa00, 50, 100);
        pointLight.position.set(5, 5, 5);
        scene.add(pointLight);

        const spotLight = new THREE.SpotLight(0xffd700, 100);
        spotLight.position.set(-10, 10, 10);
        spotLight.angle = 0.3;
        spotLight.penumbra = 1;
        scene.add(spotLight);

        // --- 后处理 (辉光 Bloom) ---
        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0;       // 阈值
        bloomPass.strength = 1.8;      // 强度 (非常亮)
        bloomPass.radius = 0.5;        // 半径
        
        const composer = new THREE.EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        // --- 核心物体 ---
        let giftBox;
        let textMesh;
        let particles;
        let isOpened = false;

        // 1. 创建礼盒 (神秘方块)
        const geometryBox = new THREE.IcosahedronGeometry(2, 0);
        giftBox = new THREE.Mesh(geometryBox, goldMaterial);
        scene.add(giftBox);

        // 2. 粒子系统 (背景星尘)
        const particlesGeometry = new THREE.BufferGeometry();
        const particlesCount = 2000;
        const posArray = new Float32Array(particlesCount * 3);
        
        for(let i = 0; i < particlesCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 60; // 分散在空间中
        }
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        particles = new THREE.Points(particlesGeometry, particleMaterial);
        scene.add(particles);

        // 3. 加载字体并创建文字 (异步)
        const loader = new FontLoader();
        loader.load('https://unpkg.com/three@0.160.0/examples/fonts/helvetiker_bold.typeface.json', function (font) {
            document.getElementById('loading').style.opacity = 0;
            setTimeout(() => { document.getElementById('instruction').style.opacity = 1; }, 500);

            const textGeo = new TextGeometry('HAPPY\nBIRTHDAY', {
                font: font,
                size: 3,
                height: 0.5, // 厚度
                curveSegments: 12,
                bevelEnabled: true,
                bevelThickness: 0.1,
                bevelSize: 0.05,
                bevelOffset: 0,
                bevelSegments: 5
            });

            textGeo.center(); // 居中
            textMesh = new THREE.Mesh(textGeo, goldMaterial);
            textMesh.position.z = -100; // 初始藏在远处
            textMesh.visible = false;
            scene.add(textMesh);
        });

        // --- 交互逻辑 ---
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();

        window.addEventListener('click', onClick);
        window.addEventListener('mousemove', onPointerMove);

        function onPointerMove(event) {
            pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
            pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        function onClick() {
            if (isOpened) return;

            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObjects([giftBox]);

            if (intersects.length > 0) {
                explodeAndReveal();
            }
        }

        function explodeAndReveal() {
            isOpened = true;
            document.getElementById('instruction').style.opacity = 0;

            // 1. 礼盒快速旋转并缩小消失
            const tl = setInterval(() => {
                giftBox.rotation.y += 0.5;
                giftBox.rotation.z += 0.5;
                giftBox.scale.multiplyScalar(0.9);
                if (giftBox.scale.x < 0.1) {
                    clearInterval(tl);
                    giftBox.visible = false;
                    
                    // 2. 文字显现
                    if(textMesh) {
                        textMesh.visible = true;
                        textMesh.position.z = -20; // 拉近
                        bloomPass.strength = 3.0; // 瞬间高光
                        setTimeout(() => { bloomPass.strength = 1.5; }, 500); // 恢复正常
                    }
                }
            }, 16);
        }

        // --- 动画循环 ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            // 礼盒待机动画
            if (!isOpened && giftBox) {
                giftBox.rotation.y = Math.sin(time) * 0.2;
                giftBox.rotation.x = Math.cos(time * 0.5) * 0.2;
                giftBox.position.y = Math.sin(time * 2) * 0.2; // 悬浮
            }

            // 粒子漂浮
            if (particles) {
                particles.rotation.y = time * 0.05;
                particles.rotation.x = time * 0.02;
            }

            // 文字动画
            if (isOpened && textMesh) {
                textMesh.rotation.y = Math.sin(time * 0.5) * 0.1; // 缓慢摆动
                // 摄像机缓慢推拉，制造呼吸感
                camera.position.z = 20 + Math.sin(time * 0.5) * 2; 
            }
            
            controls.update();
            composer.render(); // 使用后处理渲染器
        }

        animate();

        // 窗口大小自适应
        window.addEventListener('resize', onWindowResize, false);
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>