<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Happy Birthday</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; }
        #instruction {
            position: absolute; bottom: 20%; width: 100%; text-align: center;
            color: #d4af37; font-family: Arial, sans-serif; letter-spacing: 4px;
            font-size: 14px; pointer-events: none; animation: pulse 2s infinite;
            text-transform: uppercase; z-index: 10;
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
    
    <script src="https://lib.baomitu.com/three.js/r128/three.min.js"></script>
</head>
<body>
    <div id="instruction">Tap the Golden Box</div>
    <div id="canvas-container"></div>

    <script>
        // --- 错误兜底 ---
        window.onerror = function(msg) {
            document.body.innerHTML = '<div style="color:white;text-align:center;padding-top:50%;">错误: '+msg+'<br>请尝试更换浏览器</div>';
        };

        // 确保 THREE 已经加载
        if (typeof THREE === 'undefined') {
            alert('网络原因导致资源未加载，请刷新页面');
        }

        // --- 1. 场景初始化 ---
        var scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050200, 0.03); // 深金色的雾

        var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 30);

        var renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- 2. 纯手工打造的辉光材质 (无需外部插件) ---
        // 这是一个“伪辉光”技巧，用叠加混合模式模拟光晕
        var glowMaterial = new THREE.MeshBasicMaterial({
            color: 0xffaa00,
            transparent: true,
            opacity: 0.15,
            blending: THREE.AdditiveBlending,
            side: THREE.BackSide // 渲染背面，形成扩大的光圈
        });

        // --- 3. 核心物体：金盒子 ---
        var geometry = new THREE.IcosahedronGeometry(2.5, 0);
        var material = new THREE.MeshStandardMaterial({
            color: 0xffd700,
            metalness: 1.0,
            roughness: 0.2,
            emissive: 0x331100
        });
        var giftBox = new THREE.Mesh(geometry, material);
        scene.add(giftBox);

        // 添加一个包裹在盒子外面的辉光层
        var giftGlow = new THREE.Mesh(geometry, glowMaterial);
        giftGlow.scale.set(1.2, 1.2, 1.2);
        giftBox.add(giftGlow); // 辉光跟随盒子

        // --- 4. 灯光 ---
        var ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
        scene.add(ambientLight);

        var pointLight = new THREE.PointLight(0xffd700, 1.5, 50); // 强度调整为 1.5 (旧版本单位不同)
        pointLight.position.set(5, 5, 10);
        scene.add(pointLight);

        // --- 5. 文字 (Canvas 贴图) ---
        function createTextTexture(text) {
            var canvas = document.createElement('canvas');
            canvas.width = 1024;
            canvas.height = 512;
            var ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 100px "Times New Roman", serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            // 文字发光效果
            ctx.shadowColor = "#ffaa00";
            ctx.shadowBlur = 20;
            ctx.fillText(text.split('\n')[0], 512, 180);
            ctx.fillText(text.split('\n')[1], 512, 320);
            return new THREE.CanvasTexture(canvas);
        }

        var textMat = new THREE.MeshBasicMaterial({
            map: createTextTexture("HAPPY\nBIRTHDAY"),
            transparent: true,
            opacity: 0,
            color: 0xffd700,
            blending: THREE.AdditiveBlending,
            side: THREE.DoubleSide
        });
        var textPlane = new THREE.Mesh(new THREE.PlaneGeometry(12, 6), textMat);
        textPlane.position.z = -10;
        textPlane.visible = true;
        scene.add(textPlane);

        // --- 6. 粒子背景 ---
        var particlesGeo = new THREE.BufferGeometry();
        var pCount = 800;
        var pPos = new Float32Array(pCount * 3);
        for(var i=0; i<pCount*3; i++) {
            pPos[i] = (Math.random() - 0.5) * 60;
        }
        particlesGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
        var particlesMat = new THREE.PointsMaterial({
            color: 0xffaa00,
            size: 0.2,
            transparent: true,
            opacity: 0.6,
            blending: THREE.AdditiveBlending
        });
        var particles = new THREE.Points(particlesGeo, particlesMat);
        scene.add(particles);

        // --- 7. 交互与动画 ---
        var isOpened = false;
        var raycaster = new THREE.Raycaster();
        var mouse = new THREE.Vector2();

        // 统一处理点击和触摸
        function onInteract(event) {
            if(isOpened) return;
            
            var clientX, clientY;
            if(event.changedTouches) {
                clientX = event.changedTouches[0].clientX;
                clientY = event.changedTouches[0].clientY;
            } else {
                clientX = event.clientX;
                clientY = event.clientY;
            }

            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            var intersects = raycaster.intersectObject(giftBox);

            if (intersects.length > 0) {
                startAnimation();
            }
        }

        window.addEventListener('mousedown', onInteract);
        window.addEventListener('touchstart', onInteract);

        function startAnimation() {
            isOpened = true;
            document.getElementById('instruction').style.opacity = 0;

            var startTime = Date.now();
            
            function loop() {
                var elapsed = Date.now() - startTime;
                
                if (elapsed < 1000) {
                    // 爆炸前奏
                    var p = elapsed / 1000;
                    giftBox.rotation.x += 0.2;
                    giftBox.rotation.y += 0.2;
                    giftBox.scale.setScalar(1 - p);
                    // 辉光变大
                    giftGlow.scale.setScalar(1.2 + p * 2);
                    giftGlow.material.opacity = 0.15 + p * 0.5;
                } else {
                    giftBox.visible = false;
                    
                    // 文字显现
                    var textP = Math.min((elapsed - 1000) / 2000, 1);
                    textMat.opacity = textP;
                    // 简单的弹入效果
                    var scale = 0.5 + (0.5 * (1 - Math.pow(1 - textP, 3)));
                    textPlane.scale.setScalar(scale);
                }

                if (elapsed < 4000) requestAnimationFrame(loop);
            }
            loop();
        }

        // --- 8. 循环渲染 ---
        function animate() {
            requestAnimationFrame(animate);
            var time = Date.now() * 0.001;

            if(!isOpened) {
                giftBox.rotation.y = time * 0.5;
                giftBox.rotation.x = Math.sin(time) * 0.2;
                giftBox.position.y = Math.sin(time * 2) * 0.3;
            } else {
                textPlane.rotation.z = Math.sin(time) * 0.05;
                textPlane.position.y = Math.sin(time) * 0.2;
            }
            
            particles.rotation.y = time * 0.05;
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', function() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
