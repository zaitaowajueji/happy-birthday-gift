<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Gift For You</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        #canvas-container { width: 100vw; height: 100vh; }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #d4af37; font-family: 'Times New Roman', serif; letter-spacing: 5px;
            font-size: 14px; opacity: 1; transition: opacity 1s; pointer-events: none; z-index: 10;
        }
        .instruction {
            position: absolute; bottom: 15%; width: 100%; text-align: center;
            color: #fff; font-family: sans-serif; font-weight: 100; opacity: 0;
            transition: opacity 2s; letter-spacing: 2px; font-size: 12px; pointer-events: none; z-index: 10;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="loading">LOADING MAGIC...</div>
    <div id="instruction" class="instruction">CLICK THE CUBE</div>
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';

        // --- 场景初始化 ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.02);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 30);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enableZoom = false;

        // --- 材质定义 ---
        const goldMaterial = new THREE.MeshStandardMaterial({
            color: 0xffd700,
            metalness: 1.0,
            roughness: 0.15,
            emissive: 0x221100,
        });

        const particleMaterial = new THREE.PointsMaterial({
            color: 0xffeb3b,
            size: 0.1,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending
        });

        // --- 灯光系统 ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.1);
        scene.add(ambientLight);

        const pointLight = new THREE.PointLight(0xffaa00, 50, 100);
        pointLight.position.set(5, 5, 5);
        scene.add(pointLight);

        const spotLight = new THREE.SpotLight(0xffd700, 100);
        spotLight.position.set(-10, 10, 10);
        spotLight.angle = 0.3;
        scene.add(spotLight);

        // --- 后处理 (Bloom) ---
        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0;
        bloomPass.strength = 1.8;
        bloomPass.radius = 0.5;
        
        const composer = new THREE.EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        // --- 核心物体 ---
        let giftBox, textMesh, particles;
        let isOpened = false;

        // 1. 创建礼盒
        const geometryBox = new THREE.IcosahedronGeometry(2, 0);
        giftBox = new THREE.Mesh(geometryBox, goldMaterial);
        scene.add(giftBox);

        // 2. 粒子背景
        const particlesGeometry = new THREE.BufferGeometry();
        const particlesCount = 2000;
        const posArray = new Float32Array(particlesCount * 3);
        for(let i = 0; i < particlesCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 60;
        }
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        particles = new THREE.Points(particlesGeometry, particleMaterial);
        scene.add(particles);

        // --- 核心逻辑修复：字体加载 ---
        
        // 强制移除 Loading 的函数 (保险丝)
        function hideLoading() {
            const loaderEl = document.getElementById('loading');
            if (loaderEl && loaderEl.style.opacity !== '0') {
                loaderEl.style.opacity = 0;
                setTimeout(() => { 
                    const instr = document.getElementById('instruction');
                    if(instr) instr.style.opacity = 1; 
                }, 500);
            }
        }

        // 设置一个3秒的定时器，不管字体好没好，必须让用户玩
        setTimeout(hideLoading, 3000);

        const loader = new FontLoader();
        // 使用 jsDelivr 链接，通常更稳
        loader.load('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/fonts/helvetiker_bold.typeface.json', 
            function (font) {
                // 加载成功
                createTargetText(font);
                hideLoading(); // 提前结束 Loading
            },
            undefined, // onProgress
            function (err) {
                // 加载失败 (比如网络问题)
                console.log('字体加载失败，但这不影响炸开盒子');
                hideLoading(); // 即使失败也要让用户进游戏
            }
        );

        function createTargetText(font) {
            const textGeo = new TextGeometry('HAPPY\nBIRTHDAY', {
                font: font,
                size: 3,
                height: 0.5,
                curveSegments: 12,
                bevelEnabled: true,
                bevelThickness: 0.1,
                bevelSize: 0.05,
                bevelOffset: 0,
                bevelSegments: 5
            });
            textGeo.center();
            textMesh = new THREE.Mesh(textGeo, goldMaterial);
            textMesh.position.z = -100;
            textMesh.visible = false;
            scene.add(textMesh);
        }

        // --- 交互逻辑 ---
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();

        window.addEventListener('click', onClick);
        window.addEventListener('mousemove', onPointerMove);

        function onPointerMove(event) {
            pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
            pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;
        }

        function onClick() {
            if (isOpened) return;
            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObjects([giftBox]);
            if (intersects.length > 0) {
                explodeAndReveal();
            }
        }

        function explodeAndReveal() {
            isOpened = true;
            document.getElementById('instruction').style.opacity = 0;
            const tl = setInterval(() => {
                giftBox.rotation.y += 0.5;
                giftBox.rotation.z += 0.5;
                giftBox.scale.multiplyScalar(0.9);
                if (giftBox.scale.x < 0.1) {
                    clearInterval(tl);
                    giftBox.visible = false;
                    
                    if(textMesh) {
                        textMesh.visible = true;
                        textMesh.position.z = -20;
                        bloomPass.strength = 3.0;
                        setTimeout(() => { bloomPass.strength = 1.5; }, 500);
                    }
                }
            }, 16);
        }

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            if (!isOpened && giftBox) {
                giftBox.rotation.y = Math.sin(time) * 0.2;
                giftBox.rotation.x = Math.cos(time * 0.5) * 0.2;
                giftBox.position.y = Math.sin(time * 2) * 0.2;
            }
            if (particles) {
                particles.rotation.y = time * 0.05;
                particles.rotation.x = time * 0.02;
            }
            if (isOpened && textMesh) {
                textMesh.rotation.y = Math.sin(time * 0.5) * 0.1;
                camera.position.z = 20 + Math.sin(time * 0.5) * 2; 
            }
            
            controls.update();
            composer.render();
        }
        animate();

        window.addEventListener('resize', onWindowResize, false);
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
