<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Happy Birthday</title>
    <style>
        /* 1. 关键修复：禁止手机端默认的滚动和缩放，确保点击百分百触发 */
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; }
        
        #instruction {
            position: absolute; bottom: 20%; width: 100%; text-align: center;
            color: #ffd700; font-family: 'Arial', sans-serif; letter-spacing: 4px;
            font-size: 14px; pointer-events: none; animation: pulse 2s infinite;
            text-transform: uppercase; text-shadow: 0 0 10px #ffaa00; z-index: 10;
        }
        @keyframes pulse { 0% { opacity: 0.6; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.6; transform: scale(1); } }

        #debug-console { display: none; } /* 平时隐藏，出错自动弹窗 */
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="instruction">Tap the Golden Box</div>
    <div id="canvas-container"></div>

    <script>
        window.onerror = function(msg, url, line) {
            alert("运行遇到点小问题，请尝试刷新或用系统浏览器打开:\n" + msg);
        };
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- 1. 场景与高保真渲染器 ---
        const scene = new THREE.Scene();
        // 调整：雾气改为深金色，增加奢华氛围
        scene.fog = new THREE.FogExp2(0x110500, 0.02); 

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 28);

        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // 兼顾性能与清晰度
        renderer.toneMapping = THREE.ACESFilmicToneMapping; // 调整：更电影感的色调
        renderer.toneMappingExposure = 1.2;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- 2. 灯光系统 (模拟影棚布光) ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.1);
        scene.add(ambientLight);

        // 主光：暖金
        const mainLight = new THREE.PointLight(0xffaa00, 80, 100);
        mainLight.position.set(10, 10, 10);
        scene.add(mainLight);
        
        // 轮廓光：冷色，勾勒边缘，显高级
        const rimLight = new THREE.SpotLight(0x4455ff, 100);
        rimLight.position.set(-10, 10, -5);
        scene.add(rimLight);

        // 底光：反射光
        const bottomLight = new THREE.PointLight(0xff0000, 20, 50);
        bottomLight.position.set(0, -10, 5);
        scene.add(bottomLight);

        // --- 3. 极致黄金材质 ---
        const goldMaterial = new THREE.MeshStandardMaterial({
            color: 0xffd700,
            metalness: 1.0, // 纯金属
            roughness: 0.15, // 极度光滑
            emissive: 0x221100, // 微微自发光
            envMapIntensity: 1.0
        });

        // --- 4. 核心物体：神秘礼盒 ---
        const geometryBox = new THREE.IcosahedronGeometry(2.5, 0); // 调整：改为二十面体，切面更多，反光更好看
        const giftBox = new THREE.Mesh(geometryBox, goldMaterial);
        scene.add(giftBox);

        // --- 5. 核心物体：Canvas 高清文字 ---
        function createTextTexture(text) {
            const canvas = document.createElement('canvas');
            canvas.width = 1024; // 高清纹理
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // 确保背景完全透明
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#ffffff'; 
            ctx.font = '900 110px "Times New Roman", serif'; // 加粗衬线体
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // 增加文字阴影，更有立体感
            ctx.shadowColor = "rgba(255, 215, 0, 0.8)";
            ctx.shadowBlur = 20;
            
            ctx.fillText(text.split('\n')[0], 512, 180);
            ctx.fillText(text.split('\n')[1], 512, 330);

            return new THREE.CanvasTexture(canvas);
        }

        const textMat = new THREE.MeshBasicMaterial({
            map: createTextTexture("HAPPY\nBIRTHDAY"), 
            transparent: true,
            opacity: 0, // 初始透明
            color: 0xffd700,
            blending: THREE.AdditiveBlending,
            side: THREE.DoubleSide,
            depthWrite: false // 避免遮挡粒子
        });
        
        const textPlane = new THREE.Mesh(new THREE.PlaneGeometry(14, 7), textMat);
        textPlane.position.z = -10; 
        textPlane.visible = true; // 一直存在，只是透明度为0
        scene.add(textPlane);

        // --- 6. 粒子星尘 (增加数量，营造梦幻感) ---
        const particlesGeo = new THREE.BufferGeometry();
        const pCount = 1200;
        const pPos = new Float32Array(pCount * 3);
        for(let i=0; i<pCount*3; i++) {
            pPos[i] = (Math.random()-0.5) * 60;
        }
        particlesGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
        const particles = new THREE.Points(particlesGeo, new THREE.PointsMaterial({
            color: 0xffcc00, 
            size: 0.15, 
            transparent: true, 
            opacity: 0.6, 
            blending: THREE.AdditiveBlending
        }));
        scene.add(particles);

        // --- 7. 后处理 (好莱坞级辉光) ---
        const composer = new THREE.EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.strength = 1.0; // 初始辉光
        bloomPass.radius = 0.5;
        bloomPass.threshold = 0.1;
        composer.addPass(bloomPass);

        // --- 8. 交互逻辑 (手机完美适配版) ---
        let isOpened = false;
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();

        // 监听点击 (同时兼容 Mouse 和 Touch)
        window.addEventListener('pointerdown', onInteract);

        function onInteract(event) {
            if(isOpened) return;
            
            // 阻止默认行为，防止手机双击缩放
            // event.preventDefault(); 
            
            pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
            pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObject(giftBox);

            if (intersects.length > 0) {
                triggerExplosion();
            }
        }

        function triggerExplosion() {
            isOpened = true;
            document.getElementById('instruction').style.opacity = 0;
            
            const start = Date.now();
            
            function loop() {
                const now = Date.now();
                const elapsed = now - start;
                
                // 阶段1: 盒子狂暴旋转并缩小 (0-1秒)
                if (elapsed < 1000) {
                    const progress = elapsed / 1000;
                    giftBox.rotation.x += 0.3;
                    giftBox.rotation.y += 0.3;
                    const scale = 1 - progress;
                    giftBox.scale.setScalar(Math.max(0.01, scale));
                    
                    // 辉光爆发
                    bloomPass.strength = 1.0 + (progress * 4.0); 
                } 
                // 阶段2: 文字显现 (1秒后)
                else {
                    giftBox.visible = false;
                    
                    // 文字淡入 + 放大效果
                    const textProgress = Math.min((elapsed - 1000) / 1500, 1);
                    textMat.opacity = textProgress;
                    
                    // 弹簧动画
                    const ease = 1 - Math.pow(1 - textProgress, 3);
                    textPlane.scale.setScalar(0.8 + (0.2 * ease));
                    
                    // 辉光慢慢回落，保持柔和
                    bloomPass.strength = 5.0 - (textProgress * 3.5); 
                }

                if (elapsed < 5000) requestAnimationFrame(loop);
            }
            loop();
        }

        // --- 9. 渲染循环 ---
        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;

            if(!isOpened) {
                // 待机状态：盒子悬浮呼吸
                giftBox.rotation.y = time * 0.5;
                giftBox.rotation.x = Math.sin(time) * 0.2;
                giftBox.position.y = Math.sin(time * 2) * 0.3;
            } else {
                // 开启状态：文字缓慢摆动
                textPlane.rotation.z = Math.sin(time) * 0.05;
                textPlane.position.y = Math.sin(time) * 0.2;
            }
            
            // 粒子一直在动
            particles.rotation.y = time * 0.05;
            particles.rotation.z = time * 0.02;

            composer.render();
        }
        animate();

        // 窗口自适应
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
